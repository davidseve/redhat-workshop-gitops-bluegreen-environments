<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy Shop Application :: Red Hat Workshop - GitOps &amp; Blue/Green &amp; Promotion between environments</title>
    <link rel="canonical" href="https://davidseve.github.io/redhat-workshop-gitops-bluegreen-environments/redhat-workshop-gitops-bluegreen-environments/04-deploy-shop.html">
    <link rel="prev" href="03-blue-green.html">
    <link rel="next" href="05-promote-stage.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://davidseve.github.io/redhat-workshop-gitops-bluegreen-environments">Red Hat Workshop - GitOps &amp; Blue/Green &amp; Promotion between environments</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="redhat-workshop-gitops-bluegreen-environments" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#01-prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html#01-laboratory">1.2 Laboratory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-parameters">1.2.1 Parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessconsole">1.2.2 Access - OCP Console</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-configuration.html">2. Environments installation and configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-blue-green.html">3. Cloud Native Blue/Green Deployment Strategy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-microservices-architecture">3.1 Microservices Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-bluegreen-deployment-strategy">3.2 Blue/Green strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-continous-delivery">3.3 Continuous delivery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-how-to-do-bluegreen">3.4 How to do Blue/Green</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-deploy-shop.html">4. Deploy Shop Application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#04-access-the-tools">4.1 Access the tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#04-deploy-the-shop">4.2 Deploy the shop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#04-test-deployment">4.3 Test deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-promote-stage.html">5. Promote new version to Stage environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-promote-production.html">6. Promote new version to Production environment</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Workshop</a></li>
    <li><a href="04-deploy-shop.html">4. Deploy Shop Application</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/davidseve/redhat-workshop-gitops-bluegreen-environments/edit/master/documentation/modules/ROOT/pages/04-deploy-shop.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy Shop Application</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>TODO delete
%USER%</p>
</div>
<div class="paragraph">
<p>This section consists of three steps. First, get access to Openshift and ArgoCD and clone the GitOps repository. Second, deploy the application of both environments. Third, test that the deployment went well.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-access-the-tools"><a class="anchor" href="#04-access-the-tools"></a>Access the tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section focuses on getting access to the four tools that we are going to use to control the deployment of the Shop application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>OCP Client</strong>: The <code>oc</code> command will be used to create Openshift resources as well as to debug the application configuration.</p>
</li>
<li>
<p><strong>OCP Web console</strong>: The Openshift web console will be used to create Openshift resources as well as to debug the application configuration.</p>
</li>
<li>
<p><strong>ArgoCD web console</strong>: This web console helps us to visualize the sync status between Git and Openshift.</p>
</li>
<li>
<p><strong>Clone the GitOps repo</strong>: This repository contains all the deployment configurations of the application and it&#8217;s the only source of truth of the configuration.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_1_openshift_oc_client"><a class="anchor" href="#_1_openshift_oc_client"></a>1. Openshift - OC Client</h3>
<div class="paragraph">
<p>The OpenShift Container Platform CLI (which needs to be installed first) exposes the commands for managing your applications as well as the lower-level tools to interact with each component of your system. With the <code>oc</code> command, you can create applications and manage OpenShift Container Platform projects from a terminal.</p>
</div>
<div class="paragraph">
<p>Please check that you have followed the pre-requisites with your instructor and connect to the cluster executing the next command from your terminal:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u %USER%  -p openshift %CLUSTER_API%</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the login is successful, it should show an output similar to the following screenshot:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/oc_login_output.png" alt="OC CLI Login Output">
</div>
<div class="title">Figure 1. OC CLI Login Output</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please pay special attention to <em>oc CLI</em>  because you will need to use this tool several times during this tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As shown in the output, the user will have access to the following namespaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>%USER%-continuous-deployment</strong>: It will contain all the pipelines.</p>
</li>
<li>
<p><strong>%USER%-prod</strong>: Will contain the application in the production environment.</p>
</li>
<li>
<p><strong>%USER%-stage</strong>: Will contain the application in the staging environment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each user will have its own three namespaces.</p>
</div>
</div>
<div class="sect2">
<h3 id="_2_openshift_web_console"><a class="anchor" href="#_2_openshift_web_console"></a>2. Openshift - Web Console</h3>
<div class="paragraph">
<p>Access the <a href="https://console-openshift-console.apps.cluster-pdlf2.pdlf2.sandbox2869.opentlc.com/k8s/cluster/projects" target="_blank" rel="noopener">OCP web console</a> and login with your assigned username and password:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: %USER%.</p>
</li>
<li>
<p>Password: <code>openshift</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once logged in, you will see the same namespaces as using the <code>oc</code> command:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp_console_projects.png" alt="OCP web console projects view">
</div>
<div class="title">Figure 2. OCP web console projects view</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_argocd_dashboard"><a class="anchor" href="#_3_argocd_dashboard"></a>3. ArgoCD dashboard</h3>
<div class="paragraph">
<p>The ArgoCD web console will give you access to control how the git repo is synced with Openshift, as well as check the real status of the synchronization. In order to log in to the web console, access the Openshift web console and click on the following icon: You will get the link to the ArgoCD web console:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp_console_argocd_link.png" alt="Openshift link to the ArgoCD web console">
</div>
<div class="title">Figure 3. Openshift link to the ArgoCD web console</div>
</div>
<div class="paragraph">
<p>You will be requested to Log in to ArgoCD. Click on <code>LOG IN VIA OPENSHIFT</code> to be prompted for your Openshift credentials.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd_login.png" alt="ArgoCD login screen">
</div>
<div class="title">Figure 4. ArgoCD login screen</div>
</div>
<div class="paragraph">
<p>If the login is successful, you will see the home screen where your applications will be created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argocd_applications.png" alt="ArgoCD applications">
</div>
<div class="title">Figure 5. ArgoCD applications</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_clone_the_gitops_repository"><a class="anchor" href="#_4_clone_the_gitops_repository"></a>4. Clone the GitOps repository</h3>
<div class="paragraph">
<p>Following the GitOps practices, all the deployment configuration is stored in the git repo. We have created an initial repository that you will change to configure your deployment. As part of the demo, you will have to do some changes and commits. Fork the repository and clone it in your local machine, as you don&#8217;t have write permissions on the initial git repo.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the <a href="https://github.com/davidseve/cloud-native-deployment-strategies">cloud-native-deployment-strategies</a> repository and fork it on your GitHub account. If prompted, choose to fork the <code>main</code> branch.</p>
</li>
<li>
<p>Now, in your forked repository, go to <code>Settings &gt; General &gt; Pull Requests</code> and configure the repo to <code>Automatically delete head branches</code> after a PR is merged.</p>
<div class="imageblock">
<div class="content">
<img src="_images/argocd_github_pr_delete_branch.png" alt="ArgoCD login screen">
</div>
<div class="title">Figure 6. ArgoCD login screen</div>
</div>
</li>
<li>
<p>Finally, clone the repository and change to a new branch <code>release</code> using the following commands:</p>
</li>
</ol>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git clone <a href="https://github.com/your_user/cloud-native-deployment-strategies" class="bare">https://github.com/your_user/cloud-native-deployment-strategies</a>
cd cloud-native-deployment-strategies
git checkout -b release
git push origin release</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_shop_application"><a class="anchor" href="#_the_shop_application"></a>The Shop application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The shop application consists of two Quarkus applications dubbed <strong>products</strong> and <strong>discounts</strong>. When a user requests a product using the Products API, it retrieves the discount information from the Discounts microservice and then responds with all the information.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/shop_architecture.png" alt="Shop app architecture">
</div>
<div class="title">Figure 7. Shop app architecture</div>
</div>
<div class="paragraph">
<p>One of the best ways to package Cloud Native applications is <strong>Helm</strong>, as it provides a layer of abstraction that can simplify deployment whilst providing a method of repeatability. In the repository that you just forked, you will find a set of Helm charts used to deploy each of the components of the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">helm
├── quarkus-helm-base        # Defines basic config of all microservices.
├── quarkus-helm-discounts   # Deployment config for the Discounts micro.
├── quarkus-helm-networking  # Deployment config for the Networking components.
├── quarkus-helm-products    # Deployment config for the Products micro.
└── quarkus-helm-umbrella    # Main chart that combines them all.</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the previous <a href="https://helm.sh/docs/howto/charts_tips_and_tricks/#complex-charts-with-many-dependencies"><code>umbrella</code> structure</a>, each chart defines a set of Openshift resources with default values. The <code>umbrella</code> chart will be our tool to combine them all and override the variables we need.</p>
</div>
<div class="paragraph">
<p>TODO explain Helm chart</p>
</div>
<div class="paragraph">
<p>TODO explain Helm chart values</p>
</div>
<div class="paragraph">
<p>We will use this application to test the <strong>Blue/Green deployment</strong> strategy.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-deploy-the-shop"><a class="anchor" href="#04-deploy-the-shop"></a>Deploy Shop in Stage and Prod environments</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From now on, you will always modify the configuration of the repository that you just forked, as you have read-only permissions in the initial repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this section, we will create an ArgoCD <code>ApplicationSet</code> that will configure the synchronization of the git repository and Openshift. At this point, we need to stop for a bit and explain what is an ArgoCD <code>Application</code> and <code>ApplicationSet</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <code>Application</code> is an ArgoCD CRD that represents a deployed application instance in an environment. It basically synchronizes the K8s resources definitions with the actual objects deployed on Openshift.</p>
</li>
<li>
<p>An <code>ApplicationSet</code> allows you to automatically and dynamically generate ArgoCD <code>Application</code>. We will use them to generate several Applications based on the <code>values.yaml</code> files of the git repo.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please, edit the following file and set your own GitHub repository in the reportURL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {user}-shop
  namespace: openshift-gitops
spec:
  generators:
  - git:
      repoURL: https://github.com/your_user/cloud-native-deployment-strategies.git
      revision: release
      directories:
      - path: helm/quarkus-helm-umbrella/chart/values/products/envs/*
  template:
    metadata:
      name:  '{{path.basenameNormalized}}-shop-{user}'
      namespace: openshift-gitops
    spec:
      destination:
        name: ''
        namespace: '{user}-{{path.basenameNormalized}}'
        server: 'https://kubernetes.default.svc'
      source:
        path: helm/quarkus-helm-umbrella/chart
        repoURL:  https://github.com/your_user/cloud-native-deployment-strategies.git
        targetRevision: release
        helm:
          valueFiles:
            - values/products/static-products-values.yaml
            - values/products/envs/{{path.basename}}/non-static-networking-values.yaml
            - values/products/envs/{{path.basename}}/blue/image-tag-values.yaml
            - values/products/envs/{{path.basename}}/blue/non-static-values.yaml
            - values/products/envs/{{path.basename}}/green/image-tag-values.yaml
            - values/products/envs/{{path.basename}}/green/non-static-values.yaml
            - values/discounts/static-discounts-values.yaml
            - values/discounts/envs/{{path.basename}}/non-static-networking-values.yaml
            - values/discounts/envs/{{path.basename}}/blue/image-tag-values.yaml
            - values/discounts/envs/{{path.basename}}/blue/non-static-values.yaml
            - values/discounts/envs/{{path.basename}}/green/image-tag-values.yaml
            - values/discounts/envs/{{path.basename}}/green/non-static-values.yaml
      project: '{user}'
      syncPolicy:
        automated:
          prune: false
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, create the <code>ApplicationSet</code> in OpenShift:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc apply -f applicationset-shop.yaml -n openshift-gitops</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the Argo CD dashboard, you would notice that we have a new Shop application for each environment stage and prod. We can test that it is up and running.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ArgoCD-Applications.png" alt="ArgoCD Applications">
</div>
<div class="title">Figure 8. Argo CD - Shop applications</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-test-deployment"><a class="anchor" href="#04-test-deployment"></a>Test Shop in stage environment</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_online"><a class="anchor" href="#_online"></a>Online</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-online -n %USER%-stage --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_offline"><a class="anchor" href="#_offline"></a>Offline</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-offline -n %USER%-stage --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in each microservice response we have added metadata information to see better the <code>version</code>, <code>color</code>, and <code>mode</code> of each application. This will help us to see the changes while we do the Blue/Green deployment.
Because right now we have the same version v1.0.1 in both colors we will have almost the same response, only the mode will change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "products":[
     {
        "discountInfo":{
           "discounts":[
              {
                 "name":"BlackFriday",
                 "price":"1350€",
                 "discount":"10%"
              }
           ],
           "metadata":{
              "version":"v1.0.1",
              "colour":"blue",
              "mode":"online" &lt;--
           }
        },
        "name":"TV 4K",
        "price":"1500€"
     }
  ],
  "metadata":{
     "version":"v1.0.1",
     "colour":"blue",
     "mode":"online" &lt;--
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_shop_in_prod_environment"><a class="anchor" href="#_test_shop_in_prod_environment"></a>Test Shop in prod environment</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_online_2"><a class="anchor" href="#_online_2"></a>Online</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-online -n %USER%-prod --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_offline_2"><a class="anchor" href="#_offline_2"></a>Offline</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-offline -n %USER%-prod --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will have the same response in Prod environment.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-blue-green.html">3. Cloud Native Blue/Green Deployment Strategy</a></span>
  <span class="next"><a href="05-promote-stage.html">5. Promote new version to Stage environment</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
