= Promote new version to Stage environment 
include::_attributes.adoc[]

== Products Blue/Green deployment
 
We have split a `Cloud Native` Blue/Green deployment into three steps:

1. Deploy new version.
2. Switch new version to Online.
3. Align and scale down Offline.
 

 
We have already deployed the products version v1.0.1, and we are ready to use a new products version v1.1.1 that has a new `description` attribute.

First we are going to focus on Stage environment, to validate the the new products version v1.1.1 works properly.

This is our current status:

.Shop initial status
image::blue-green-step-0.png[]


== Step 1 - Deploy new version

We will start deploying a new version v1.1.1 in the offline color.

Those are the main tasks that we have to execute:

- Set new tag image values in the offline color.
- Change the application configuration values to use the online services.
- Scale Up the offline color.
- Commit the changes in a new branch and create a pull request.

If we do not automate those tasks, we will have to see which is the offline color and make all the changes on it in the right values files.
However we can automate it in a pipeline. The pipelines will find the offline color, make the changes and create the pull request.


[tabs]
====
Manual steps::
+
--
[.console-input]
[source,sh,subs="+macros,+attributes"]
----
cd helm/quarkus-helm-umbrella/chart
----

Edit file values/products/envs/stage/green/image-tag-values.yaml

Set this content to deploy new version v1.1.1
```yaml
products-green:
  quarkus-base:
    image:
      tag: v1.1.1
```

Edit file values/products/envs/stage/green/non-static-values.yaml

Set this content to use online backend and scale up.
```yaml
products-green:
  quarkus-base:
    replicaCount: 2
  mode: online
```

Commit the changes in a new branch and create a pull request
[.console-input]
[source,input,subs="+macros,+attributes"]
----
git checkout -b new-image-v1.1.1
git add values/products/envs/stage/green
git commit -m 'products-green  new image tag v1.1.1'
git push origin new-image-v1.1.1
----
--
Automatic pipeline::
+
--
You can use the already created pipelinerun. 
[source,yaml]
----
include::example$run-products-stage/1-pipelinerun-products-new-version.yaml[]
----

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc create -f 1-pipelinerun-products-new-version.yaml -n {user}-continuous-delivery
----
--
====
TODO explain the pull request
TODO add image
Accept pull request and delete the branch.

ArgoCD will synchronize the application with the new changes. You can do it manually to make it faster.

.Argo CD - Refresh Shop
image::ArgoCD-Shop-Refresh.png[]

This will be the Shop status:

.Shop step 1
image::blue-green-step-1.png[]

See that offline applications have version v1.1.1 and the new attribute description, but the online has not changed.

[.console-input]
[source,input,subs="+macros,+attributes"]
----
curl "$(oc get routes products-umbrella-offline -n {user}-stage --template='https://{{.spec.host}}')/products"
----

```json
{
  "products":[
     {
        "discountInfo":{
            "discounts":[...],
            "metadata":{
               "version":"v1.0.1",
               "colour":"blue",
               "mode":"online" <--
            }
        }, 
        "name":"TV 4K",
        "price":"1500€",
        "description":"The best TV" <--
     }
  ],
  "metadata":{
     "version":"v1.1.1", <--
     "colour":"green",
     "mode":"online" <--
  }
}
```
Functional testing users can execute `Smoke tests` to validate this new v1.1.1 version.


== Step 2 - Switch new version to Online

We are going to open the new version to final users. To do so we just have to change the online service to use the other color.

TODO explian more

[tabs]
====
Manual steps::
+
--

TODO

--
Automatic pipeline::
+
--
You can use the already created pipelinerun. 
[source,yaml]
----
include::example$run-products-stage/2-pipelinerun-products-switch.yaml[]
----

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc create -f 2-pipelinerun-products-switch.yaml -n {user}-continuous-delivery
----
--
====

TODO explain the pull request
TODO add image
Accept pull request and delete the branch.

ArgoCD will synchronize the application with the new changes. You can do it manually to make it faster.

This will be the Shop status:

.Shop step 2
image::blue-green-step-2.png[]

[.console-input]
[source,input,subs="+macros,+attributes"]
----
curl "$(oc get routes products-umbrella-online  -n {user}-stage  --template='https://{{.spec.host}}')/products"
----

**We have in the online environment the new version v1.1.1!!!**
```json
{
  "products":[
     {
        "discountInfo":{...},
        "name":"TV 4K",
        "price":"1500€",
        "description":"The best TV" <--
     }
  ],
  "metadata":{
     "version":"v1.1.1", <--
     "colour":"green",
     "mode":"online" <--
  }
}
```

== Step 3 - Align and scale down Offline

Finally, when online is stable we should align offline with the new version and scale it down. Does not make sense to use the same resources that we have in online.

[tabs]
====
Manual steps::
+
--

TODO

--
Automatic pipeline::
+
--
You can use the already created pipelinerun. 
[source,yaml]
----
include::example$run-products-stage/3-pipelinerun-products-aling-offline.yaml[]
----

[.console-input]
[source,input,subs="+macros,+attributes"]
----
oc create -f 3-pipelinerun-products-aling-offline.yaml -n {user}-continuous-delivery
----
--
====


TODO explain the pull request
TODO add image
Accept pull request and delete the branch.

ArgoCD will synchronize the application with the new changes. You can do it manually to make it faster.

.Shop step 3
image::blue-green-step-3.png[]

[.console-input]
[source,input,subs="+macros,+attributes"]
----
curl "$(oc get routes products-umbrella-offline -n {user}-stage --template='https://{{.spec.host}}')/products"
----

We can see that the offline `Products` is calling offline `Discounts` and has the new version v1.1.1
```json
{
  "products":[
     {
        "discountInfo":{
           "discounts":[
              {
                 "name":"BlackFriday",
                 "price":"1350€",
                 "discount":"10%",
                 "description":null
              }
           ],
           "metadata":{
              "version":"v1.0.1",
              "colour":"green",
              "mode":"offline" <--
           }
        },
        "name":"TV 4K",
        "price":"1500€",
        "description":"The best TV"
     }
  ],
  "metadata":{
     "version":"v1.1.1", <--
     "colour":"blue",
     "mode":"offline" <--
  }
}
```