<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy Shop Application :: Red Hat Workshop - GitOps &amp; Blue/Green &amp; Promotion between environments</title>
    <link rel="canonical" href="https://davidseve.github.io/redhat-workshop-gitops-bluegreen-environments/redhat-workshop-gitops-bluegreen-environments/04-deploy-shop.html">
    <link rel="prev" href="03-blue-green.html">
    <link rel="next" href="05-promote-stage.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://davidseve.github.io/redhat-workshop-gitops-bluegreen-environments">Red Hat Workshop - GitOps &amp; Blue/Green &amp; Promotion between environments</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="redhat-workshop-gitops-bluegreen-environments" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#01-prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html#01-laboratory">1.2 Laboratory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-parameters">1.2.1 Parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessconsole">1.2.2 Access - OCP Console</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-configuration.html">2. Environments installation and configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-blue-green.html">3. Cloud Native Blue/Green Deployment Strategy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-microservices-architecture">3.1 Microservices Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-bluegreen-deployment-strategy">3.2 Blue/Green strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-continous-delivery">3.3 Continuous delivery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-how-to-do-bluegreen">3.4 How to do Blue/Green</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="04-deploy-shop.html">4. Deploy Shop Application</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-promote-stage.html">5. Promote new version to Stage environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-promote-production.html">6. Promote new version to Production environment</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Workshop</a></li>
    <li><a href="04-deploy-shop.html">4. Deploy Shop Application</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/davidseve/redhat-workshop-gitops-bluegreen-environments/edit/master/documentation/modules/ROOT/pages/04-deploy-shop.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploy Shop Application</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>TODO delete
%USER%</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="04-accessoc"><a class="anchor" href="#04-accessoc"></a>Access - OC Client</h3>
<div class="paragraph">
<p>The OpenShift Container Platform CLI (which needs to be installed first) exposes the commands for managing your applications as well as the lower-level tools to interact with each component of your system.</p>
</div>
<div class="paragraph">
<p>Please review the previous settings with your instructor and connect to the cluster executing next command from your terminal:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u %USER%  -p openshift %CLUSTER_API%</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO change image
.OC CLI Login Output
image::oc_login_output.png[]</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please pay special attention to <em>oc CLI</em>  because you will need to use this tool several times during this tutorial.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TODO
explain the namespaces</p>
</div>
</div>
<div class="sect1">
<h2 id="_log_into_argo_cd_dashboard"><a class="anchor" href="#_log_into_argo_cd_dashboard"></a>Log into Argo CD dashboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clone_repo"><a class="anchor" href="#_clone_repo"></a>Clone repo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have a GitHub repository for this demo. As part of the demo, you will have to do some changes and commits. So it is important that you fork the repository and clone it in your local.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git clone <a href="https://github.com/your_user/cloud-native-deployment-strategies" class="bare">https://github.com/your_user/cloud-native-deployment-strategies</a>
cd cloud-native-deployment-strategies
git checkout -b release
git push origin release</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_shop_in_stage_and_prod_environments"><a class="anchor" href="#_deploy_shop_in_stage_and_prod_environments"></a>Deploy Shop in Stage and Prod environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to create the application Shop, that we will use to test Blue/Green deployment. Because we will make changes in the application&#8217;s GitHub repository, we have to use the repository that you have just forked. Please edit the following file and set your own GitHub repository in the reportURL.</p>
</div>
<div class="paragraph">
<p>TODO explane applicationset</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {user}-shop
  namespace: openshift-gitops
spec:
  generators:
  - git:
      repoURL: https://github.com/your_user/cloud-native-deployment-strategies.git
      revision: release
      directories:
      - path: helm/quarkus-helm-umbrella/chart/values/products/envs/*
  template:
    metadata:
      name:  '{{path.basenameNormalized}}-shop-{user}'
      namespace: openshift-gitops
    spec:
      destination:
        name: ''
        namespace: '{user}-{{path.basenameNormalized}}'
        server: 'https://kubernetes.default.svc'
      source:
        path: helm/quarkus-helm-umbrella/chart
        repoURL:  https://github.com/your_user/cloud-native-deployment-strategies.git
        targetRevision: release
        helm:
          valueFiles:
            - values/products/static-products-values.yaml
            - values/products/envs/{{path.basename}}/non-static-networking-values.yaml
            - values/products/envs/{{path.basename}}/blue/image-tag-values.yaml
            - values/products/envs/{{path.basename}}/blue/non-static-values.yaml
            - values/products/envs/{{path.basename}}/green/image-tag-values.yaml
            - values/products/envs/{{path.basename}}/green/non-static-values.yaml
            - values/discounts/static-discounts-values.yaml
            - values/discounts/envs/{{path.basename}}/non-static-networking-values.yaml
            - values/discounts/envs/{{path.basename}}/blue/image-tag-values.yaml
            - values/discounts/envs/{{path.basename}}/blue/non-static-values.yaml
            - values/discounts/envs/{{path.basename}}/green/image-tag-values.yaml
            - values/discounts/envs/{{path.basename}}/green/non-static-values.yaml
      project: '{user}'
      syncPolicy:
        automated:
          prune: false
          selfHeal: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create this ApplicatinSet in OpenShift:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc apply -f applicationset-shop.yaml -n openshift-gitops</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking at the Argo CD dashboard, you would notice that we have a new Shop application for each environment stage and prod. We can test that it is up and running.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ArgoCD-Applications.png" alt="ArgoCD Applications">
</div>
<div class="title">Figure 1. Argo CD - Shop applications</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_shop_in_stage_environment"><a class="anchor" href="#_test_shop_in_stage_environment"></a>Test Shop in stage environment</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_online"><a class="anchor" href="#_online"></a>Online</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-online -n %USER%-stage --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_offline"><a class="anchor" href="#_offline"></a>Offline</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-offline -n %USER%-stage --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in each microservice response we have added metadata information to see better the <code>version</code>, <code>color</code>, and <code>mode</code> of each application. This will help us to see the changes while we do the Blue/Green deployment.
Because right now we have the same version v1.0.1 in both colors we will have almost the same response, only the mode will change.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "products":[
     {
        "discountInfo":{
           "discounts":[
              {
                 "name":"BlackFriday",
                 "price":"1350€",
                 "discount":"10%"
              }
           ],
           "metadata":{
              "version":"v1.0.1",
              "colour":"blue",
              "mode":"online" &lt;--
           }
        },
        "name":"TV 4K",
        "price":"1500€"
     }
  ],
  "metadata":{
     "version":"v1.0.1",
     "colour":"blue",
     "mode":"online" &lt;--
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_shop_in_prod_environment"><a class="anchor" href="#_test_shop_in_prod_environment"></a>Test Shop in prod environment</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_online_2"><a class="anchor" href="#_online_2"></a>Online</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-online -n %USER%-prod --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_offline_2"><a class="anchor" href="#_offline_2"></a>Offline</h3>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-offline -n %USER%-prod --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will have the same response in Prod environment.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-blue-green.html">3. Cloud Native Blue/Green Deployment Strategy</a></span>
  <span class="next"><a href="05-promote-stage.html">5. Promote new version to Stage environment</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
