<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promote new version to Stage environment :: Red Hat Workshop - GitOps &amp; Blue/Green &amp; Promotion between environments</title>
    <link rel="canonical" href="https://davidseve.github.io/redhat-workshop-gitops-bluegreen-environments/redhat-workshop-gitops-bluegreen-environments/06-promote-stage.html">
    <link rel="prev" href="05-deploy-shop.html">
    <link rel="next" href="07-promote-production.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://davidseve.github.io/redhat-workshop-gitops-bluegreen-environments">Red Hat Workshop - GitOps &amp; Blue/Green &amp; Promotion between environments</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="redhat-workshop-gitops-bluegreen-environments" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Environment Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#01-prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html#01-laboratory">1.2 Laboratory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-parameters">1.2.1 Parameters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-setup.html#01-accessconsole">1.2.2 Access - OCP Console</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-configuration.html">2. Environments installation and configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-blue-green.html">3. Cloud Native Blue/Green Deployment Strategy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-microservices-architecture">3.1 Microservices Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-bluegreen-deployment-strategy">3.2 Blue/Green strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-continous-delivery">3.3 Continuous delivery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-blue-green.html#03-how-to-do-bluegreen">3.4 How to do Blue/Green</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-access-the-tools.html">4. Access the tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-deploy-shop.html">5. The Shop application</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-shop.html#04-deploy-the-shop">5.1 Deploy the shop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-deploy-shop.html#04-test-deployment">5.2 Test deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="06-promote-stage.html">6. Promote new version to Stage environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-promote-production.html">7. Promote new version to Production environment</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Workshop</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Workshop</a></li>
    <li><a href="06-promote-stage.html">6. Promote new version to Stage environment</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/davidseve/redhat-workshop-gitops-bluegreen-environments/edit/master/documentation/modules/ROOT/pages/06-promote-stage.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Promote new version to Stage environment</h1>
<div class="sect1">
<h2 id="_products_bluegreen_deployment"><a class="anchor" href="#_products_bluegreen_deployment"></a>Products Blue/Green deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have split a <code>Cloud Native</code> Blue/Green deployment into three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Deploy the new version.</p>
</li>
<li>
<p>Switch the new version to Online.</p>
</li>
<li>
<p>Align and scale down Offline.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We have already deployed the <code>products</code> version <code>v1.0.1</code> and we are ready to use a new <code>products</code> version <code>v1.1.1</code> that has a new <code>description</code> attribute.</p>
</div>
<div class="paragraph">
<p>First, we are going to focus on <strong>Stage environment</strong> to validate that the new <code>products</code> version <code>v1.1.1</code> works properly.</p>
</div>
<div class="paragraph">
<p>This is our current status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blue-green-step-0.png" alt="blue green step 0">
</div>
<div class="title">Figure 1. Shop initial status</div>
</div>
<div class="paragraph">
<p>TODO add github token in chapter 4</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_deploy_the_new_version"><a class="anchor" href="#_step_1_deploy_the_new_version"></a>Step 1 - Deploy the new version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will start deploying a new version <code>v1.1.1</code> in the offline color. And get it ready to receive online user&#8217;s traffic</p>
</div>
<div class="paragraph">
<p>These are the main tasks that we have to execute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set the new image tag values in the offline color.</p>
</li>
<li>
<p>Change the application configuration values to use the online services.</p>
</li>
<li>
<p>Scale up the offline color.</p>
</li>
<li>
<p>Commit the changes in a new branch and create a pull request.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If we do not automate those tasks, we will have to see which is the offline color and make all the changes in the right values files.
However, we can automate it in a pipeline. The pipelines will find the offline color, make the changes in the right values files and create the pull request.</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_manual-steps"></a>Manual steps</p>
</li>
<li>
<p><a id="tabset1_automatic-pipeline"></a>Automatic pipeline</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_manual-steps">
<div class="paragraph">
<p>We can get the offline color from Openshift service or from the file <code>values/products/envs/stage/non-static-networking-values.yaml</code>. Then edit the following files in the right environment and color.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd helm/quarkus-helm-umbrella/chart</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set new tag image values in the offline color.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Edit the file <code>values/products/envs/stage/green/image-tag-values.yaml</code>.
Set its content to deploy new version <code>v1.1.1</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">products-green:
  quarkus-base:
    image:
      tag: v1.1.1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the application configuration values to use the online services.</p>
</li>
<li>
<p>Scale Up the offline color.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Edit the file <code>values/products/envs/stage/green/non-static-values.yaml</code>.
Set this content to use the online backend and scale up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">products-green:
  quarkus-base:
    replicaCount: 2
  mode: online</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commit the changes in a new branch and push them to your repository:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git checkout -b new-image-v1.1.1
git add values/products/envs/stage/green
git commit -m 'products-green  new image tag v1.1.1'
git push origin new-image-v1.1.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, create a pull request from the <code>new-image-v1.1.1</code> to the <code>release</code> branch:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/github-create-pr.png" alt="github create pr">
</div>
<div class="title">Figure 2. Pull request notification on GitHub</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_automatic-pipeline">
<div class="paragraph">
<p>We have created a pipeline that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gets the offline color in the designed environment.</p>
</li>
<li>
<p>Changes the right files to deploy a new version.</p>
</li>
<li>
<p>Commits the changes in a new branch and creates a pull request.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: shop-products-new-version-
spec:
  pipelineRef:
    name: pipeline-blue-green-environments    
  params:
  - name: APP
    value: products
  - name: NEW_IMAGE_TAG
    value: "v1.1.1"
  - name: STEP
    value: "new-version"
  - name: REPLICA_COUNT
    value: "2"   
  - name: NAMESPACE
    value: "%USER%-stage"
  - name: REPO_FULL_NAME
    value: %REPOSITORY%/cloud-native-deployment-strategies
  workspaces:
  - name: app-source
    persistentVolumeClaim:
      claimName: workspace-pvc-shop-cd-new-version</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -f 1-pipelinerun-products-new-version.yaml -n %USER%-continuous-deployment</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should have the following pull request:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/github-pr1-stage.png" alt="github pr1 stage">
</div>
<div class="title">Figure 3. GitHub New Version Pull Request</div>
</div>
<div class="paragraph">
<p>With those files changed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gihub-stage-pr1-changed.png" alt="gihub stage pr1 changed">
</div>
<div class="title">Figure 4. GitHub New Version Pull Request Files Changed</div>
</div>
<div class="paragraph">
<p>Accept the pull request and delete the branch.</p>
</div>
<div class="paragraph">
<p>ArgoCD will synchronize the application with the new changes. You can do it manually but to make it faster, click on the <code>SYNC</code> button.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ArgoCD-Shop-Refresh.png" alt="ArgoCD Shop Refresh">
</div>
<div class="title">Figure 5. Argo CD - Refresh Shop</div>
</div>
<div class="paragraph">
<p>After ArgoCD synchronizes, this will be the Shop status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blue-green-step-1.png" alt="blue green step 1">
</div>
<div class="title">Figure 6. Shop step 1</div>
</div>
<div class="paragraph">
<p>See that offline color has version <code>v1.1.1</code> and the new attribute description, but the online has not changed.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-offline -n %USER%-stage --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "products":[
     {
        "discountInfo":{
            "discounts":[...],
            "metadata":{
               "version":"v1.0.1",
               "colour":"blue",
               "mode":"online" &lt;--
            }
        },
        "name":"TV 4K",
        "price":"1500€",
        "description":"The best TV" &lt;--
     }
  ],
  "metadata":{
     "version":"v1.1.1", &lt;--
     "colour":"green",
     "mode":"online" &lt;--
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Functional testing users can execute <code>Smoke tests</code> to validate this new <code>v1.1.1</code> version.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_switch_new_version_to_online"><a class="anchor" href="#_step_2_switch_new_version_to_online"></a>Step 2 - Switch new version to Online</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to open the new version to final users. To do so, we just have to change the online service to use the other color that we have ready.</p>
</div>
<div class="paragraph">
<p>These are the main tasks that we have to execute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the online service.</p>
</li>
<li>
<p>Commit the changes in a new branch and create a pull request.</p>
</li>
</ul>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_manual-steps"></a>Manual steps</p>
</li>
<li>
<p><a id="tabset2_automatic-pipeline"></a>Automatic pipeline</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_manual-steps">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd helm/quarkus-helm-umbrella/chart</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the online service</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Edit the file <code>values/products/envs/stage/non-static-networking-values.yaml</code>.
Set this content to use the green color in the online service.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">productsNetworkingOnline:
  version: green
productsNetworkingOffline:
  version: green</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commit the changes in a new branch and create a pull request</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git checkout -b switch-to-colout-green-image-v1.1.1
git add values/products/envs/stage/non-static-networking-values.yaml
git commit -m 'products switch online to green'
git push origin switch-to-colout-green-image-v1.1.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a Pull Request on the GitHub website like in the previous step.</p>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset2_automatic-pipeline">
<div class="paragraph">
<p>We have created a pipeline that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get the offline color in the designed environment.</p>
</li>
<li>
<p>Execute an E2E test to validate the version.</p>
</li>
<li>
<p>Change the right files for the online service.</p>
</li>
<li>
<p>Commit the changes in a new branch and create a pull request.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: shop-products-switch-
spec:
  pipelineRef:
    name: pipeline-blue-green-environments   
  params:
  - name: APP
    value: products
  - name: STEP
    value: "switch"
  - name: NEW_IMAGE_TAG
    value: "v1.1.1"
  - name: NAMESPACE
    value: "%USER%-stage"
  - name: REPO_FULL_NAME
    value: %REPOSITORY%/cloud-native-deployment-strategies
  workspaces:
  - name: app-source
    persistentVolumeClaim:
      claimName: workspace-pvc-shop-cd-new-version</pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -f 2-pipelinerun-products-switch.yaml -n %USER%-continuous-deployment</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should have the following pull request:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/github-pr2-stage.png" alt="github pr2 stage">
</div>
<div class="title">Figure 7. GitHub Switch Pull Request</div>
</div>
<div class="paragraph">
<p>With those files changed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gihub-stage-pr2-changed.png" alt="gihub stage pr2 changed">
</div>
<div class="title">Figure 8. GitHub Switch Pull Request Files Changed</div>
</div>
<div class="paragraph">
<p>Accept the pull request and delete the branch. ArgoCD will synchronize the application with the new changes. You can do it manually, to make it faster, click on <code>SYNC</code> button.</p>
</div>
<div class="paragraph">
<p>After ArgoCD synchronizes the repository with Openshift, this will be the Shop status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blue-green-step-2.png" alt="blue green step 2">
</div>
<div class="title">Figure 9. Shop step 2</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-online  -n %USER%-stage  --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>We have the online service using the new version <code>v1.1.1</code>!!!</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "products":[
     {
        "discountInfo":{...},
        "name":"TV 4K",
        "price":"1500€",
        "description":"The best TV" &lt;--
     }
  ],
  "metadata":{
     "version":"v1.1.1", &lt;--
     "colour":"green",
     "mode":"online" &lt;--
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_align_and_scale_down_offline"><a class="anchor" href="#_step_3_align_and_scale_down_offline"></a>Step 3 - Align and scale down Offline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, when online is stable we should align offline with the new version and scale it down. It does not make sense to use the same resources that we have in the online deployment.</p>
</div>
<div class="paragraph">
<p>These are the main tasks that we have to execute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set new tag image values in the new offline color.</p>
</li>
<li>
<p>Change the application configuration values to use the offline services.</p>
</li>
<li>
<p>Scale down the new offline color.</p>
</li>
<li>
<p>Change the offline service to use the new offline color.</p>
</li>
<li>
<p>Commit the changes in a new branch and create a pull request.</p>
</li>
</ul>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_manual-steps"></a>Manual steps</p>
</li>
<li>
<p><a id="tabset3_automatic-pipeline"></a>Automatic pipeline</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_manual-steps">
<div class="paragraph">
<p>We can get the new offline color from Openshift service or from the file <code>values/products/envs/stage/non-static-networking-values.yaml</code>. Then edit the following files in the right environment and color.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">cd helm/quarkus-helm-umbrella/chart</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Set new tag image values in the new offline color.
Edit the file <code>values/products/envs/stage/blue/image-tag-values.yaml</code>.
Set this content to deploy new version <code>v1.1.1</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">products-blue:
  quarkus-base:
    image:
      tag: v1.1.1</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the application configuration values to use the offline services.</p>
</li>
<li>
<p>Scale Down the new offline color.
Edit the file <code>values/products/envs/stage/blue/non-static-values.yaml</code>.
Set this content to use online backend and scale up.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">products-blue:
  quarkus-base:
    replicaCount: 1
  mode: offline</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the offline service to use the new offline color.
Edit the file <code>values/products/envs/stage/non-static-networking-values.yaml</code>.
Set this content to use the blue color in the offline service.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">productsNetworkingOnline:
  version: green
productsNetworkingOffline:
  version: blue</code></pre>
</div>
</div>
<div class="paragraph">
<p>Commit the changes in a new branch and create a pull request</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">git checkout -b align-offline-v1.1.1
git add values/products/envs/stage/blue
git add values/products/envs/stage/non-static-networking-values.yaml
git commit -m 'products-blue env stage align image tag v1.1.1'
git push origin align-offline-v1.1.1</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset3_automatic-pipeline">
<div class="paragraph">
<p>We have created a pipeline that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get the offline color in the designed environment.</p>
</li>
<li>
<p>Change the right files to align the color and scale down.</p>
</li>
<li>
<p>Commit the changes in a new branch and create a pull request.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: shop-products-align-offline-
spec:
  pipelineRef:
    name: pipeline-blue-green-environments      
  params:
  - name: APP
    value: products
  - name: NEW_IMAGE_TAG
    value: "v1.1.1"
  - name: STEP
    value: "align-offline"
  - name: NAMESPACE
    value: "user1-stage"
  - name: REPO_FULL_NAME
    value: %REPOSITORY%/cloud-native-deployment-strategies
  workspaces:
  - name: app-source
    persistentVolumeClaim:
      claimName: workspace-pvc-shop-cd-new-version</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -f 3-pipelinerun-products-align-offline.yaml -n %USER%-continuous-deployment</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>You should have the following pull request:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/github-pr3-stage.png" alt="github pr3 stage">
</div>
<div class="title">Figure 10. GitHub Align Pull Request</div>
</div>
<div class="paragraph">
<p>With those files changed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/gihub-stage-pr3-changed.png" alt="gihub stage pr3 changed">
</div>
<div class="title">Figure 11. GitHub Align Pull Request Files Changed</div>
</div>
<div class="paragraph">
<p>Accept the pull request and delete the branch. ArgoCD will synchronize the application with the new changes. You can do it manually but, to make it faster, click on the <code>SYNC</code> button.</p>
</div>
<div class="paragraph">
<p>After ArgoCD synchronizes the git repository, this will be the Shop status:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/blue-green-step-3.png" alt="blue green step 3">
</div>
<div class="title">Figure 12. Shop step 3</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl "$(oc get routes products-umbrella-offline -n %USER%-stage --template='https://{{.spec.host}}')/products"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the offline <code>Products</code> is calling offline <code>Discounts</code> and has the new version <code>v1.1.1</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "products":[
     {
        "discountInfo":{
           "discounts":[
              {
                 "name":"BlackFriday",
                 "price":"1350€",
                 "discount":"10%",
                 "description":null
              }
           ],
           "metadata":{
              "version":"v1.0.1",
              "colour":"green",
              "mode":"offline" &lt;--
           }
        },
        "name":"TV 4K",
        "price":"1500€",
        "description":"The best TV"
     }
  ],
  "metadata":{
     "version":"v1.1.1", &lt;--
     "colour":"blue",
     "mode":"offline" &lt;--
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>We are ready to promote the new version to the production environment!!</strong></p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="05-deploy-shop.html" class="query-params-link">5. The Shop application</a></span>
  <span class="next"><a href="07-promote-production.html" class="query-params-link">7. Promote new version to Production environment</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
